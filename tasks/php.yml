---
- name: Install dependencies for Sury PHP repository
  apt:
    name:
      - lsb-release
      - apt-transport-https
      - ca-certificates
      - curl
    state: present

- name: Download Sury PHP GPG key
  get_url:
    url: https://packages.sury.org/php/apt.gpg
    dest: /usr/share/keyrings/sury-php.gpg
    mode: '0644'

- name: Add Sury PHP repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/sury-php.gpg] https://packages.sury.org/php/ {{ ansible_distribution_release }} main"
    state: present
    filename: sury-php

- name: Install PHP and modules
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - "php{{ php_version }}"
    - "php{{ php_version }}-cli"
    - "php{{ php_version }}-fpm"
    - "php{{ php_version }}-common"
    - "php{{ php_version }}-bcmath"
    - "php{{ php_version }}-gd"
    - "php{{ php_version }}-intl"
    - "php{{ php_version }}-mbstring"
    - "php{{ php_version }}-mysql"
    - "php{{ php_version }}-opcache"
    - "php{{ php_version }}-soap"
    - "php{{ php_version }}-xml"
    - "php{{ php_version }}-zip"
    - "php{{ php_version }}-curl"
    - "php{{ php_version }}-readline"
    - "php{{ php_version }}-bz2"
    # mcrypt was available in 7.1/7.3
    - "php{{ php_version }}-mcrypt"

- name: Ensure PHP-FPM is started and enabled
  service:
    name: "php{{ php_version }}-fpm"
    state: started
    enabled: yes

- name: Set PHP {{ php_version }} as default CLI version
  command: update-alternatives --set php /usr/bin/php{{ php_version }}
  # Run this only if the version exists, though the previous task ensures it's installed.
  # We suppress changed status to keep output clean, or you can add a check logic.
  changed_when: false

- name: Install Composer
  apt:
    name: composer
    state: present
